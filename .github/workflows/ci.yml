name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger for E2E tests

jobs:
  # Detect which files changed to decide which jobs to run
  # Strategy: Skip tests/lint/docker for docs-only changes (.claude/, docs/, README.md, etc.)
  # This saves CI time (~2-7 min) when only documentation is updated
  changes:
    runs-on: ubuntu-latest
    outputs:
      ui: ${{ steps.filter.outputs.ui }}
      code: ${{ steps.filter.outputs.code }}
      static: ${{ steps.filter.outputs.static }}
      infra: ${{ steps.filter.outputs.infra }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
    - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
      id: filter
      with:
        filters: |
          # UI files (for E2E smart logic)
          ui:
            - 'app/ui/**'
            - 'app/services/**'
            - 'tests/e2e/**'
            - 'main.py'
            - '.env.test'
            - 'pyproject.toml'
          # Infrastructure files (Docker, CI)
          infra:
            - 'Dockerfile'
            - 'docker-compose*.yml'
            - '.github/workflows/**'
          # Code changes (app code, tests, dependencies)
          code:
            - 'app/**'
            - 'tests/**'
            - 'main.py'
            - 'pyproject.toml'
            - 'uv.lock'
            - '.env.*'
          # Static assets (images, logos, themes)
          static:
            - 'static/**'
          # Documentation only (user-facing docs, AI context, README)
          docs:
            - 'docs/**'
            - '.claude/**'
            - 'README.md'
            - 'CONTRIBUTING.md'
            - 'mkdocs.yml'

  test-unit:
    runs-on: ubuntu-latest
    needs: [changes]
    # Run only if code changed (skip for docs-only or static-only changes)
    if: needs.changes.outputs.code == 'true'

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        fetch-depth: 0  # Full history for SonarCloud blame analysis

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904 # v7
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Install dependencies
      run: |
        uv sync --frozen

    - name: Run unit tests (excluding E2E)
      run: |
        uv run pytest -m "not e2e" --cov=app --cov-report=term --cov-report=xml

    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  lint:
    runs-on: ubuntu-latest
    needs: [changes]
    # Run only if code changed (skip for docs-only or static-only changes)
    if: needs.changes.outputs.code == 'true'

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904 # v7
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Install dependencies
      run: |
        uv sync --frozen --all-extras

    - name: Run ruff format (formatter check)
      run: |
        uv run ruff format --check .

    - name: Run ruff check (linter)
      run: |
        uv run ruff check .

    - name: Run mypy (type checker)
      run: |
        uv run mypy app --ignore-missing-imports
      continue-on-error: true

  test-e2e:
    runs-on: ubuntu-latest
    needs: [changes]
    # Smart E2E Strategy:
    # ✅ Always run on: push to main, manual trigger
    # ✅ Run on PR when: UI/code files changed OR static assets changed OR [e2e] in commit message
    # ❌ Skip if: [skip e2e] in commit message OR only docs changed
    if: |
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.static == 'true') &&
      !contains(github.event.head_commit.message, '[skip e2e]') && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        needs.changes.outputs.ui == 'true' ||
        contains(github.event.head_commit.message, '[e2e]')
      )

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904 # v7
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Install dependencies
      run: |
        uv sync --frozen

    - name: Install Playwright browsers
      run: |
        uv run playwright install --with-deps chromium

    - name: Run E2E tests
      run: |
        uv run pytest tests/e2e/ -v --browser chromium

  docker:
    runs-on: ubuntu-latest
    needs: [changes]
    # Run if code, static, or infrastructure files changed (skip for docs-only changes)
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.static == 'true' || needs.changes.outputs.infra == 'true'

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

    - name: Build Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
      with:
        context: .
        push: false
        tags: kanso:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
